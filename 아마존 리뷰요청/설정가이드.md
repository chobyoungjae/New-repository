# 아마존 리뷰 요청 자동화 시스템 설정 가이드

## 📋 목차
1. [사전 준비사항](#사전-준비사항)
2. [Amazon SP-API 설정](#amazon-sp-api-설정)
3. [Google Apps Script 배포](#google-apps-script-배포)
4. [Script Properties 설정](#script-properties-설정)
5. [실행 및 테스트](#실행-및-테스트)
6. [트러블슈팅](#트러블슈팅)

---

## 사전 준비사항

### 필요한 계정
- ✅ Amazon Seller Central 계정 (Professional Plan)
- ✅ AWS 계정 (IAM 사용자 생성용)
- ✅ Google 계정 (Google Spreadsheet 사용)

### 준비할 정보
1. **LWA (Login with Amazon) 자격증명**
   - Client ID
   - Client Secret
   - Refresh Token

2. **AWS IAM 자격증명**
   - Access Key ID
   - Secret Access Key

3. **Amazon 마켓플레이스 정보**
   - Marketplace ID (예: ATVPDKIKX0DER - 미국)
   - SP-API Endpoint (예: https://sellingpartnerapi-na.amazon.com)
   - AWS Region (예: us-east-1)

---

## Amazon SP-API 설정

### 1단계: Developer Central에서 애플리케이션 등록

1. [Amazon Seller Central Developer Console](https://sellercentral.amazon.com/developer/console) 접속
2. **Apps & Services** → **Develop apps** 클릭
3. **Add new app client** 클릭
4. 애플리케이션 정보 입력:
   - **App name**: `Review Request Automation`
   - **OAuth Redirect URI**: 테스트용 URI 입력 (예: `https://localhost`)

5. **Create App** 클릭 후 저장:
   - ✅ **LWA Client ID** 복사
   - ✅ **LWA Client Secret** 복사

### 2단계: IAM Role 생성 및 권한 부여

1. [Seller Central Developer Console](https://sellercentral.amazon.com/developer/console)에서:
   - **View ARN** 클릭
   - IAM ARN 복사 (예: `arn:aws:iam::123456789012:role/SellingPartnerAPI`)

2. AWS IAM 콘솔 접속:
   - IAM 사용자 생성
   - **Programmatic access** 체크
   - ✅ **Access Key ID** 저장
   - ✅ **Secret Access Key** 저장

### 3단계: Refresh Token 발급

**OAuth 2.0 인증 플로우 사용:**

```bash
# 1. 인증 URL 생성
https://sellercentral.amazon.com/apps/authorize/consent?application_id={YOUR_APP_ID}&state=stateexample&version=beta

# 2. 브라우저에서 위 URL 접속 → 권한 승인
# 3. Redirect URL에서 spapi_oauth_code 추출

# 4. Refresh Token 발급 요청
curl -X POST \
  https://api.amazon.com/auth/o2/token \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  -d 'grant_type=authorization_code' \
  -d 'code={SPAPI_OAUTH_CODE}' \
  -d 'client_id={CLIENT_ID}' \
  -d 'client_secret={CLIENT_SECRET}'
```

**응답에서 `refresh_token` 값을 복사하여 저장하세요.**

✅ **LWA Refresh Token** 저장

---

## Google Apps Script 배포

### 1단계: Google Spreadsheet 생성

1. [Google Sheets](https://sheets.google.com) 접속
2. 새 스프레드시트 생성
3. 파일명: `아마존 리뷰 요청 관리`

### 2단계: Apps Script 프로젝트 연결

1. 스프레드시트에서 **확장 프로그램** → **Apps Script** 클릭
2. 기본 `Code.gs` 파일의 내용을 모두 삭제
3. 제공된 `Code.js` 파일의 내용을 복사하여 붙여넣기
4. **프로젝트 설정** (⚙️ 아이콘) 클릭:
   - `appsscript.json` 매니페스트 편집 활성화
   - 제공된 `appsscript.json` 내용으로 교체

5. 파일 저장: **프로젝트 저장** (💾 아이콘) 클릭

---

## Script Properties 설정

### 설정 방법

1. Apps Script 에디터에서 **프로젝트 설정** (⚙️) 클릭
2. **스크립트 속성** 섹션으로 스크롤
3. **스크립트 속성 추가** 클릭하여 아래 항목들을 하나씩 추가:

### 필수 속성 목록

| 속성 이름 | 설명 | 예시 값 |
|----------|------|---------|
| `LWA_CLIENT_ID` | Amazon LWA Client ID | `amzn1.application-oa2-client.xxxxx` |
| `LWA_CLIENT_SECRET` | Amazon LWA Client Secret | `amzn1.oa2-cs.v1.xxxxx` |
| `LWA_REFRESH_TOKEN` | Amazon LWA Refresh Token | `Atzr\|IwEBIxxxxx` |
| `AWS_ACCESS_KEY_ID` | AWS IAM Access Key | `AKIAIOSFODNN7EXAMPLE` |
| `AWS_SECRET_ACCESS_KEY` | AWS IAM Secret Key | `wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY` |
| `AWS_REGION` | AWS 리전 | `us-east-1` |
| `MARKETPLACE_ID` | Amazon Marketplace ID | `ATVPDKIKX0DER` (미국) |
| `SP_API_ENDPOINT` | SP-API 엔드포인트 URL | `https://sellingpartnerapi-na.amazon.com` |

### Marketplace ID 참고

| 국가 | Marketplace ID | Endpoint |
|------|---------------|----------|
| 미국 | ATVPDKIKX0DER | https://sellingpartnerapi-na.amazon.com |
| 캐나다 | A2EUQ1WTGCTBG2 | https://sellingpartnerapi-na.amazon.com |
| 영국 | A1F83G8C2ARO7P | https://sellingpartnerapi-eu.amazon.com |
| 독일 | A1PA6795UKMFR9 | https://sellingpartnerapi-eu.amazon.com |
| 일본 | A1VC38T7YXB528 | https://sellingpartnerapi-fe.amazon.com |

---

## 실행 및 테스트

### 1단계: 설정 확인

1. Google Spreadsheet를 새로고침
2. 상단 메뉴에 **🔄 리뷰 요청** 메뉴가 표시되는지 확인
3. **🔄 리뷰 요청** → **⚙️ 설정 확인** 클릭
4. "✅ 모든 설정이 완료되었습니다!" 메시지 확인

### 2단계: 수동 테스트 실행

1. **🔄 리뷰 요청** → **🚀 수동 실행** 클릭
2. 권한 승인 팝업이 뜨면:
   - **고급** 클릭 → **{프로젝트명}(으)로 이동** 클릭
   - **허용** 클릭

3. 실행 로그 확인:
   - Apps Script 에디터에서 **실행** 탭 클릭
   - 실행 내역 확인

4. 스프레드시트에 **리뷰요청** 시트 자동 생성 확인
5. 주문 데이터가 추가되었는지 확인

### 3단계: 자동 실행 트리거 설정

1. **🔄 리뷰 요청** → **⏰ 트리거 설정** 클릭
2. 매일 오전 10시 자동 실행 트리거 생성 완료

**트리거 확인:**
- Apps Script 에디터에서 **트리거** (⏰ 아이콘) 클릭
- `dailyReviewRequestJob` 함수의 트리거 확인

---

## 트러블슈팅

### 1. "LWA Token 발급 실패" 오류

**원인:**
- Client ID, Client Secret, Refresh Token이 잘못됨

**해결:**
1. Script Properties의 `LWA_CLIENT_ID`, `LWA_CLIENT_SECRET`, `LWA_REFRESH_TOKEN` 값 재확인
2. Refresh Token이 만료되었을 수 있음 → 새로 발급
3. [Amazon Token Exchange](https://developer-docs.amazon.com/sp-api/docs/authorizing-selling-partner-api-applications) 참고

### 2. "서명 오류" (403 Forbidden)

**원인:**
- AWS SigV4 서명이 잘못되거나 IAM 권한 부족

**해결:**
1. `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY` 재확인
2. IAM 사용자에 `execute-api` 권한 부여 확인
3. AWS Region과 Endpoint가 일치하는지 확인

### 3. "주문 데이터 없음"

**원인:**
- 최근 30일간 배송 완료 후 5~30일 사이의 FBA 주문이 없음
- Marketplace ID가 잘못됨

**해결:**
1. Seller Central에서 실제 주문 데이터 확인
2. `MARKETPLACE_ID`가 판매 국가와 일치하는지 확인
3. `FulfillmentChannel`이 "AFN"(FBA)인 주문만 처리됨

### 4. "Rate Limit 초과" (429)

**원인:**
- API 호출 횟수 제한 초과

**해결:**
- 자동 재시도 로직이 작동하므로 대기
- 주문 수가 많을 경우 `Utilities.sleep()` 지연 시간 증가

### 5. "리뷰 요청 불가" 상태

**원인:**
- 이미 리뷰 요청이 발송됨
- 배송 후 30일 경과
- 구매자가 리뷰 요청 거부

**해결:**
- 정상 동작입니다. 해당 주문은 요청 불가 상태로 기록됩니다.

---

## 추가 정보

### API 할당량

- **Orders API**: 초당 0.0167 요청 (1분당 1회)
- **Solicitations API**: 초당 0.0167 요청 (1분당 1회)

**자동 처리:**
- 코드 내 `Utilities.sleep(500)` 으로 Rate Limit 관리
- 429 에러 발생 시 지수 백오프 재시도 (1초 → 2초 → 4초)

### 데이터 보안

- 모든 API 키는 Script Properties에 안전하게 저장
- Google Apps Script는 Google의 보안 인프라에서 실행
- 스프레드시트 공유 설정에 주의 (민감한 주문 정보 포함)

### 비용

- **Google Apps Script**: 무료
- **Amazon SP-API**: 무료
- **AWS IAM**: 무료

---

## 문의 및 지원

- Amazon SP-API 문서: https://developer-docs.amazon.com/sp-api/
- Google Apps Script 문서: https://developers.google.com/apps-script

---

**작성일**: 2025-10-13
**버전**: 1.0.0
