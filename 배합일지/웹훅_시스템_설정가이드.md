# 웹훅 기반 이카운트 자동화 시스템 설정 가이드

## 🎯 전체 구조

```
Google Sheets (클라우드)
    ↓ 웹훅 HTTP POST
Python 서버 (localhost:5000)
    ↓ VBS 스크립트 실행
Excel VBA (로컬 파일)
    ↓ 이카운트 자동화
이카운트 ERP 시스템
```

## 📋 1단계: Google Apps Script 설정

### 1.1 스크립트 배포
1. Google Apps Script 에디터에서 **배포** → **새 배포** 클릭
2. **유형**: 웹 앱
3. **실행 계정**: 나
4. **액세스 권한**: 모든 사용자
5. **배포** 클릭 후 **웹 앱 URL** 복사

### 1.2 스크립트 ID 확인
- 웹 앱 URL에서 `/macros/s/` 다음에 오는 긴 문자열이 **스크립트 ID**
- 예: `https://script.google.com/macros/s/AKfycbz.../exec`
- `AKfycbz...` 부분이 스크립트 ID

## 📋 2단계: 로컬 환경 설정

### 2.1 Python 설치 및 서버 설정

#### Python 설치 확인
```bash
python --version
```

#### Flask 설치
```bash
pip install flask
```

#### 파일 준비
다음 파일들을 `Y:\4000_생산(조병재)\2025년\ERP 생산등록2 자동\` 폴더에 복사:
- `webhook_server.py`
- `trigger_icount_upload.vbs`

### 2.2 Excel VBA 설정

#### VBA 코드 추가
1. `Y:\4000_생산(조병재)\2025년\ERP 생산등록2 자동\ERP생산등록.xlsx` 파일 열기
2. **Alt + F11** → VBA 에디터 열기
3. **삽입** → **모듈** → 새 모듈 추가
4. `ICountAutomation.vba` 내용을 모듈에 복사
5. **중요**: `SCRIPT_ID` 상수를 실제 스크립트 ID로 변경:
   ```vba
   Private Const SCRIPT_ID = "AKfycbz실제스크립트ID여기에입력"
   ```

#### VBA 보안 설정
1. **파일** → **옵션** → **보안 센터** → **보안 센터 설정**
2. **매크로 설정** → **모든 매크로 사용**
3. **신뢰할 수 있는 위치**에 Excel 파일 경로 추가

## 📋 3단계: 시스템 시작

### 3.1 Python 웹훅 서버 실행

#### 명령 프롬프트에서 실행
```bash
cd "Y:\4000_생산(조병재)\2025년\ERP 생산등록2 자동"
python webhook_server.py
```

#### 성공 시 출력
```
============================================================
🚀 이카운트 ERP 웹훅 서버 시작
============================================================
서버 주소: http://localhost:5000
VBA 스크립트: trigger_icount_upload.vbs
Excel 파일: Y:\4000_생산(조병재)\2025년\ERP 생산등록2 자동\ERP생산등록.xlsx
============================================================
 * Running on http://localhost:5000
```

### 3.2 자동 시작 설정 (선택사항)

#### startup.bat 파일 생성
`Y:\4000_생산(조병재)\2025년\ERP 생산등록2 자동\startup.bat`:
```batch
@echo off
cd /d "Y:\4000_생산(조병재)\2025년\ERP 생산등록2 자동"
echo 이카운트 웹훅 서버를 시작합니다...
python webhook_server.py
pause
```

#### Windows 시작프로그램에 추가
1. **Win + R** → `shell:startup`
2. `startup.bat` 바로가기 생성

## 📋 4단계: 테스트 실행

### 4.1 서버 상태 확인
브라우저에서 `http://localhost:5000` 접속
→ 서버 상태 JSON 응답 확인

### 4.2 VBA 개별 테스트
Excel VBA에서 다음 함수들을 개별 실행:
```vba
' Google Sheets API 연결 테스트
Sub TestGoogleSheetsAPI()

' JSON 파싱 테스트  
Sub TestJSONParsing()

' Excel 업데이트 테스트
Sub TestFullSystemWithoutUpload()
```

### 4.3 전체 시스템 테스트
1. Google Sheets에서 **"생산뷰"** → **"타임스템프 이동"** 클릭
2. Python 서버 콘솔에서 웹훅 수신 로그 확인
3. Excel 파일에서 `1_생산입고II` 시트 생성 및 데이터 입력 확인

## 🔧 트러블슈팅

### 문제 1: "웹훅 서버 연결 실패"
**원인**: Python 서버가 실행되지 않음
**해결**: 
- 명령 프롬프트에서 `python webhook_server.py` 실행
- 포트 5000이 사용중인지 확인: `netstat -an | findstr :5000`

### 문제 2: "Google Apps Script ID가 설정되지 않았습니다"
**원인**: VBA 코드에서 SCRIPT_ID 미설정
**해결**:
1. Google Apps Script 웹 앱 URL에서 ID 확인
2. VBA 코드의 `SCRIPT_ID` 상수 업데이트

### 문제 3: "Excel 파일을 찾을 수 없습니다"
**원인**: 파일 경로 불일치
**해결**:
- `webhook_server.py`의 `EXCEL_FILE_PATH` 확인
- `trigger_icount_upload.vbs`의 `EXCEL_FILE_PATH` 확인
- 실제 Excel 파일 경로와 일치하는지 확인

### 문제 4: "VBA 실행 실패"
**원인**: 매크로 보안 설정 또는 VBA 코드 오류
**해결**:
- Excel 매크로 보안 설정 확인
- VBA 즉시 창(Ctrl+G)에서 오류 메시지 확인

## 📊 모니터링

### 로그 확인
- **Python 서버**: `webhook.log` 파일
- **VBA 실행**: Excel VBA 즉시 창 (Ctrl+G)
- **웹 브라우저**: `http://localhost:5000/logs`

### 성능 지표
- **응답 시간**: Google Sheets → Python 서버 (< 1초)
- **처리 시간**: VBA 실행 (10-30초)
- **전체 소요시간**: 약 1-2분

## 🎯 사용법

### 일상 사용
1. **Python 서버 확인**: `http://localhost:5000` 접속
2. **Google Sheets**: "생산뷰" → "타임스템프 이동" 클릭
3. **결과 확인**: Excel `1_생산입고II` 시트에서 데이터 확인

### 서버 재시작
```bash
# 서버 중지: Ctrl+C
# 서버 재시작:
cd "Y:\4000_생산(조병재)\2025년\ERP 생산등록2 자동"
python webhook_server.py
```

## 🔄 업데이트 및 유지보수

### 코드 업데이트 시
1. Google Apps Script: `clasp push` 또는 웹에서 직접 수정
2. Python 서버: 파일 수정 후 서버 재시작
3. VBA: Excel 파일에서 직접 수정

### 백업 권장사항
- Excel 파일 정기 백업
- VBA 코드 버전 관리
- Python 서버 로그 아카이브

## ⚠️ 주의사항

1. **Python 서버는 24시간 실행** 상태 유지 권장
2. **방화벽 설정**: localhost 통신 허용 확인
3. **백업**: 자동화 전 데이터 백업 필수
4. **테스트**: 실제 이카운트 연동 전 충분한 테스트

## 🆘 지원 연락처

- **기술 문의**: VBA 코드 주석 참조
- **로그 분석**: `webhook.log` 파일 확인
- **디버깅**: Excel VBA 즉시 창 (Ctrl+G) 활용