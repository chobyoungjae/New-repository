# 중량선별기 실시간 데이터 수집 시스템 진행 현황 보고서

## 📋 프로젝트 개요

**목표**: 인테크 중량선별기의 RS-485 통신을 통해 측정 데이터를 실시간으로 Google Sheets에 업로드하는 시스템 구축

**시스템 구성**:

```
[중량선별기] ←RS-485→ [라즈베리파이 4B] ←Wi-Fi→ [Google Sheets]
```

---

## ✅ 완료된 작업 (진행률: 85%)

### 1. 하드웨어 구축 완료 ✅

- **라즈베리파이 4B (4GB)**: 설치 및 설정 완료
- **RS-485 to TTL 컨버터**: 하드웨어 연결 완료
- **전원 및 케이블**: 모든 연결 완료

### 2. 라즈베리파이 시스템 설정 완료 ✅

- **OS 설치**: Raspberry Pi OS (64-bit) 완료
- **네트워크 설정**: Wi-Fi 연결 완료
- **SSH 접속**: 원격 접속 설정 완료
  - 호스트: checkweigher-\*\*\*\*
  - IP: 192.168.0.\*\*\*
  - 사용자: checkweigher-\*\*\*\*
- **UART 활성화**: 시리얼 통신 설정 완료

### 3. 소프트웨어 환경 구축 완료 ✅

- **Python 가상환경**: 생성 및 활성화 완료
- **필수 라이브러리 설치**: pyserial, gspread, google-auth 등 완료
- **프로젝트 구조**: 폴더 및 파일 구조 생성 완료

### 4. Google Sheets API 연동 완료 ✅

- **Google Cloud Console**: 프로젝트 생성 및 API 활성화 완료
- **서비스 계정**: 인증 정보 설정 완료
- **스프레드시트 연결**: 테스트 업로드 **성공 확인** ✅
  - 스프레드시트 ID: 1bf1Rtb5e7MTLtD5Qp3AGbytPMQl4JyZr457sGGc0MVw
  - 시트명: "1라인"
- **테스트 결과**: `python test_sheets.py` **정상 작동 확인**

### 5. 시리얼 포트 설정 완료 ✅

- **시리얼 포트 확인**: `/dev/serial0`, `/dev/ttyAMA0`, `/dev/ttyS0` 모두 존재
- **권한 설정**: dialout 그룹 추가 완료
- **포트 연결**: 시리얼 포트 정상 인식

---

## ❌ 현재 막힌 문제 (진행률: 15%)

### 🚨 **핵심 문제: RS-485 데이터 수신 실패**

#### 현재 상황

```bash
(venv) checkweigher-1line@checkweigher-1line:~/checkweigher $ python test_serial_simple.py

=== 테스트 중: /dev/serial0 - 9600bps ===
연결 성용! 5초간 대기...
..... 완료  ← 데이터 수신 안됨

=== 테스트 중: /dev/serial0 - 4800bps ===
연결 성공! 5초간 대기...
..... 완료  ← 데이터 수신 안됨

... (모든 포트/보드레이트 조합에서 동일한 결과)
```

#### 예상되는 원인

1. **중량선별기 RS-485 출력 설정 문제**

   - RS-485 포트가 비활성화 상태일 가능성
   - 통신 프로토콜 설정 불일치
   - 데이터 출력 조건 미설정

2. **하드웨어 연결 문제**

   - RS-485 A+/B- 라인 연결 오류
   - GND 공통 접지 미연결
   - 케이블 불량 또는 접촉 불량

3. **통신 설정 불일치**
   - 보드레이트(통신속도) 불일치
   - 데이터 비트/패리티/스톱비트 설정 차이

---

## 🔧 현재 하드웨어 연결 상태

### RS-485 연결 다이어그램

```
중량선별기 → RS-485 컨버터 → 라즈베리파이
485+ (A) → A (노랑선) → (데이터 라인)
485- (B) → B (파랑선) → (데이터 라인)
GND     → Gnd (검정선) → Pin 9 (GND)
        → Vcc (빨강선) → Pin 2 (5V)
        → Ro (초록선) → Pin 10 (GPIO15/RXD)
        → Di (흰색선) → Pin 8 (GPIO14/TXD)
        → 쿨러(빨강)  → Pin 2
        → 쿨러(빨검)  → Pin 4
```

### 연결 체크리스트

- ✅ 전원 공급: RS-485 모듈 전원 LED 점등 확인
- ✅ 시리얼 포트: 라즈베리파이에서 포트 인식 확인
- ❓ 데이터 라인: 485+/485- 연결 상태 (확인 필요)
- ❓ 공통 접지: 중량선별기 GND 연결 상태 (확인 필요)

---

## 🎯 해결 필요 사항 (업체 지원 요청)

### 1. 중량선별기 통신 설정 확인 필요 ⚠️

다음 설정들을 중량선별기 메뉴에서 확인 및 설정 요청:

#### A. 통신 포트 설정

- **Ch.2 (RS-485) 포트 활성화** 여부 확인
- USB(Ch.1)가 아닌 RS-485(Ch.2) 사용 설정

#### B. 통신 파라미터 설정

- **통신속도**: 9600bps 설정 (권장)
- **데이터 비트**: 8비트
- **패리티**: None (없음)
- **스톱 비트**: 1비트
- **프로토콜**: Remote 또는 HM 프로토콜 선택

#### C. 데이터 출력 설정

- **RS-485 출력**: ON (활성화)
- **출력 조건**: 측정 완료 시 자동 출력
- **데이터 형식**: CSV 형식 (DATE,TIME,P_No,LOT,COUNT,GRADE,WEIGHT)

### 2. 하드웨어 연결 재점검 필요

- **485+ (A)선**: 중량선별기와 RS-485 컨버터 올바른 연결 확인
- **485- (B)선**: 중량선별기와 RS-485 컨버터 올바른 연결 확인
- **GND 공통 접지**: 중량선별기, RS-485 컨버터, 라즈베리파이 GND 연결

### 3. 테스트용 데이터 출력 확인

- 중량선별기에서 **수동으로 테스트 데이터 전송** 기능이 있는지 확인
- RS-485 포트에서 **데이터가 실제로 출력되는지** 확인 가능 여부

---

## 📊 기대되는 데이터 형식

### 정상 수신 시 예상 데이터

```
2025-08-08,10:45:23,1,LOT001,12345,PASS,52.8
2025-08-08,10:45:35,1,LOT001,12346,PASS,48.2
2025-08-08,10:45:47,1,LOT001,12347,FAIL,65.3
```

### 데이터 필드 설명

- **DATE**: 측정 날짜 (YYYY-MM-DD)
- **TIME**: 측정 시간 (HH:MM:SS)
- **P_No**: 제품 번호
- **LOT**: 로트 번호
- **COUNT**: 누적 개수
- **GRADE**: 합격/불합격 (PASS/FAIL)
- **WEIGHT**: 측정 중량(g)

---

## 🔍 테스트 스크립트 정보

### 현재 실행 중인 테스트

```bash
# 위치: ~/checkweigher/
python test_serial_simple.py
```

### 테스트 내용

- **3개 시리얼 포트** 순차 테스트: /dev/serial0, /dev/ttyS0, /dev/ttyAMA0
- **4개 보드레이트** 순차 테스트: 9600, 4800, 19200, 38400 bps
- **총 12개 조합** 자동 테스트 (각 5초씩, 총 약 1분)

### 테스트 결과

- ✅ **시리얼 포트 연결**: 모든 포트에서 "연결 성공" 확인
- ❌ **데이터 수신**: 모든 조합에서 데이터 수신 실패

---

## 📈 다음 단계 (문제 해결 후)

### 즉시 진행 가능한 작업들

1. **실시간 데이터 수신 확인** (5분)
2. **Google Sheets 자동 업로드 테스트** (10분)
3. **통합 시스템 구동 테스트** (30분)
4. **24/7 자동 실행 서비스 등록** (15분)

### 최종 완성 예상 시간

**RS-485 데이터 수신만 해결되면 1시간 내 전체 시스템 완성 가능**

---

## 📞 긴급 지원 요청 사항

### 즉시 확인 필요

1. **중량선별기 RS-485 출력 설정 상태**
2. **통신 파라미터 설정값** (보드레이트, 프로토콜 등)
3. **테스트 데이터 수동 출력 가능 여부**

### 현장 지원 요청

- **중량선별기 메뉴 조작 방법** 안내
- **통신 설정 변경** 지원
- **하드웨어 연결 상태** 재점검

---

## 📋 시스템 사양 요약

### 하드웨어

- **메인 컨트롤러**: Raspberry Pi 4B (4GB RAM)
- **통신 인터페이스**: RS-485 to TTL 컨버터 (MAX485)
- **전원**: 5V 3A 어댑터
- **저장**: MicroSD 64GB

### 소프트웨어

- **OS**: Raspberry Pi OS (64-bit)
- **언어**: Python 3.9+
- **주요 라이브러리**: pyserial, gspread, google-auth
- **클라우드**: Google Sheets API

### 네트워크

- **연결 방식**: Wi-Fi (802.11ac)
- **원격 접속**: SSH (포트 22)
- **데이터 업로드**: Google Sheets API (HTTPS)

---

## 📧 연락처 및 지원 요청

**현재 상황**: RS-485 통신에서 중량선별기 데이터가 수신되지 않는 상태

**긴급도**: 높음 (전체 시스템의 85% 완료, 마지막 단계)

**지원 요청**: 중량선별기 RS-485 통신 설정 및 하드웨어 연결 점검

---

## 📝 참고 문서

- **설치 가이드**: COMPLETE_SETUP_GUIDE.md
- **설정 파일**: config/settings.json
- **테스트 스크립트**: test_serial_simple.py, test_sheets.py
- **하드웨어 매뉴얼**: 7인치 중량선별기 통신매뉴얼.pdf

---

## 🔍 현장 확인 결과 (추가 업데이트)

### 하드웨어 연결 상태 ✅

- **RS-485 물리적 연결**: 중량선별기 메인보드 RS-485 단자에 올바르게 연결 완료
- **케이블 연결**: A+, B-, GND 모두 정확한 위치에 연결 확인

### 중량선별기 설정 화면 확인 결과 ❌

- **채널 2 (RS-485) 접근**: 정상적으로 접근 가능
- **🚨 핵심 문제 발견**: 채널 2 설정에서 **COM1, COM4만 선택 가능**
- **RS-485 옵션 없음**: 채널 2에서 RS-485 직접 선택 옵션이 표시되지 않음

### 추정되는 문제 원인

1. **중량선별기 펌웨어 설정 문제**:

   - RS-485 기능이 비활성화 상태일 가능성
   - COM1/COM4가 RS-485 매핑되지 않은 상태

2. **통신 프로토콜 설정 필요**:

   - COM1 또는 COM4 중 하나가 RS-485와 매핑될 가능성
   - 추가 설정 메뉴에서 RS-485 활성화 필요할 수 있음

3. **매뉴얼 미확인 설정**:
   - 숨겨진 설정 메뉴가 있을 가능성
   - 특정 키 조합으로 RS-485 설정 접근 필요할 수 있음

### 🆘 업체 긴급 지원 요청 사항 (수정)

#### 즉시 확인 필요 사항

1. **COM1, COM4 중 어느 것이 RS-485와 연결되는지** 확인
2. **RS-485 활성화를 위한 추가 설정 메뉴** 위치 안내
3. **채널 2에서 RS-485 직접 선택하는 방법** 안내
4. **중량선별기 펌웨어 버전** 및 RS-485 지원 여부 확인

#### 테스트 요청

- COM1 설정으로 RS-485 데이터 출력 테스트
- COM4 설정으로 RS-485 데이터 출력 테스트
- 각 설정에서 테스트 데이터 수동 전송 가능 여부

### 현재 상황 요약

- ✅ **물리적 연결**: 완료 (하드웨어 문제 아님)
- ❌ **소프트웨어 설정**: COM1/COM4 vs RS-485 매핑 불명확
- 🔄 **다음 단계**: 업체 기술지원을 통한 정확한 설정 방법 확인 필요

---

**마지막 업데이트**: 2025년 8월 8일 (현장 확인 결과 추가)
**작성자**: 시스템 개발팀
