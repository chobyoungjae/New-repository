# 코드 비교 분석 및 수정사항 정리

## 📋 분석 대상 파일

**✅ 정상 파일 (기준) - 수정하면 안됨:**
- `0덮] 1동 제품검수일지(대시보드) 유니크네임 타입 (전중후)`

**🔧 수정 대상 파일:**
- 기타 모든 대시보드 파일들 (상황에 따라 변경)

---

## 🔍 주요 차이점 분석

### 1. **팀장 보드로 데이터 전송 시점의 차이** 📋 **참고용 - 수정하지 않음**

> ⚠️ **중요**: 이 차이는 각 파일의 고유한 비즈니스 로직이므로 **절대 수정하지 않습니다**

#### ✅ 정상 파일 (1동 제품검수일지) - 상태별 전송
```javascript
// onFormSubmit에서 '제품생산 완료' 상태일 때
if (status === '제품생산 완료') {
    // 팀장 보드 전송 로직
    if (info) pushToBoard(info.boardId, 'leader', row); // 보드 전송
}
```

#### 📝 청소상태 체크일지 - 즉시 전송 (기존 로직 유지)
```javascript
// onFormSubmit에서 바로 팀장 보드로 전송
// ▶ 보드로 전송
const leader = data().getRange(row, CFG.COL.CEO).getDisplayValue().trim();
if (leader) {
    const info = lookupBoardByName(leader);
    if (info) pushToBoard(info.boardId, 'leader', row, sheetUrl); // 보드에 전송
}
```

### 2. **PDF 생성 시점과 방식의 차이**

#### ✅ 정상 파일 (1동 제품검수일지) - 2단계 PDF 생성
1. **1단계: 팀장 보드로 전송 시 PDF 생성**
   ```javascript
   function pushToBoard(boardId, role, srcRow) {
       // PDF 생성하고 파일 ID 획득
       const pdfFileId = createPdfFromSheet(srcRow, false); // << 첫 번째 PDF 생성

       // 팀장 보드 O열에 PDF 파일 ID 저장
       const metaData = [[srcRow], [null], [null], [null], [pdfFileId]]; // O열에 PDF 파일 ID
       sh.getRange(dstRow, 11, 1, 5).setValues([metaData.flat()]);
   }
   ```

2. **2단계: 팀장 서명 시 최종 PDF 생성**
   ```javascript
   function exportPdfAndNotify(row) {
       // 기존 PDF 파일 휴지통으로 이동 후 새 PDF 생성
       const pdfFileId = createPdfFromSheet(row, true); // moveOldToTrash = true
   }
   ```

#### ❌ 수정 필요 파일 (청소상태 체크일지) - 1단계만 PDF 생성
```javascript
function pushToBoard(boardId, role, srcRow, url) {
    // PDF 생성 없음 - 단순히 시트 URL만 전송
    const vals = [
        ts,
        docName,
        data().getRange(srcRow, 2).getValue(),
        data().getRange(srcRow, 19).getValue(), // 시트명만 전송
    ];

    // O열에 개인 시트 URL 저장 (PDF 파일 ID가 아님)
    if (url) sh.getRange(dstRow, 15).setValue(url); // 개인 시트 링크
}

function exportPdfAndNotify(row) {
    // 팀장 서명 시에만 PDF 생성 (기존 파일 휴지통 이동 없음)
    DriveApp.getFolderById(CFG.PDF_FOLDER).createFile(blob);
    ss.deleteSheet(sheet); // 시트만 삭제
}
```

### 3. **팀장 보드 O열에 저장되는 데이터 차이**

#### ✅ 정상 파일
- **O열**: PDF 파일 ID (예: `1HVCgS7kErKVqcw4Lhao4QL8fKJzttI-Y`)

#### ❌ 수정 필요 파일
- **O열**: Google Sheets URL (예: `https://docs.google.com/spreadsheets/d/1jZtChRhQTpQ33lMfrNnpZSl-OrkBFcDWMrmq6YAd0y0/edit?gid=840055863`)

---

## 🛠️ 수정 작업 계획

### **수정사항 1: pushToBoard 함수 업데이트**
```javascript
function pushToBoard(boardId, role, srcRow) { // url 파라미터 제거
    // PDF 생성하고 파일 ID 획득 추가
    const pdfFileId = createPdfFromSheet(srcRow, false); // << 첫 번째 PDF 생성

    // 팀장 보드 O열에 PDF 파일 ID 저장 로직 추가
    const metaData = [[srcRow], [null], [null], [null], [pdfFileId]]; // O열에 PDF 파일 ID
    sh.getRange(dstRow, 11, 1, 5).setValues([metaData.flat()]);
}
```

### **수정사항 2: createPdfFromSheet 함수 추가**
- 정상 파일의 `createPdfFromSheet` 함수 로직을 청소상태 체크일지에 맞게 적용
- `moveOldToTrash` 파라미터 지원
- 파일 ID 반환 기능 추가

### **수정사항 3: exportPdfAndNotify 함수 업데이트**
```javascript
function exportPdfAndNotify(row) {
    // 기존 PDF 휴지통 이동 후 새 PDF 생성 로직 추가
    const pdfFileId = createPdfFromSheet(row, true); // moveOldToTrash = true
}
```

### **수정사항 4: 함수 호출부 수정**
```javascript
// onFormSubmit에서 pushToBoard 호출 시 url 파라미터 제거
if (info) pushToBoard(info.boardId, 'leader', row); // sheetUrl 파라미터 제거
```

---

## 🔄 **워크플로우 패턴별 분류**

### **패턴 A: 단일 승인자 (현재 청소상태 체크일지)**
```
설문 작성 → 팀장 보드 전송 → 팀장 서명 → PDF 생성 (완료)
```

### **패턴 B: 다중 승인자 (3단계 승인)**
```
설문 작성 → PDF 생성 → 팀장 보드 전송 (PDF ID)
→ 팀장 서명 → 메인 스프레드시트 서명 데이터 전송
→ 기존 PDF 휴지통 → 새로운 PDF 생성
→ 검토자 보드 전송 (새로운 PDF ID)
→ 검토자 서명 → 메인 스프레드시트 서명 데이터 전송
→ 기존 PDF 휴지통 → 새로운 PDF 생성
→ 대표자 보드 전송 (새로운 PDF ID)
→ 대표자 서명 → 메인 스프레드시트 서명 데이터 전송
→ 기존 PDF 휴지통 → 최종 PDF 생성 (완료)
```

> ⚠️ **중요**: 각 승인 단계마다 **새로운 PDF ID가 다음 보드 O열로 전송**됩니다

## 📝 적용 대상 파일 목록

이 수정사항은 다음과 같은 패턴의 모든 Google Apps Script 파일에 적용해야 합니다:

1. **팀장 보드로 데이터 전송하는 모든 파일 (패턴 A & B)**
2. **PDF 생성 기능이 있는 모든 대시보드 파일**
3. **현재 시트 URL을 O열에 저장하고 있는 모든 파일**
4. **다중 승인자 워크플로우를 가진 파일 (패턴 B)**

---

## 🚨 **크리티컬 주의사항** 🚨

### **절대 원칙 - 기존 로직 보존**

> ⚠️ **CRITICAL**: 수정 과정에서 **기존 비즈니스 로직은 절대 변경하면 안됩니다**

#### **1. 보존해야 할 기존 로직들**
- ✅ **폼 제출 시점과 조건**: 언제 팀장 보드로 전송하는지 (상태별 vs 즉시)
- ✅ **데이터 매핑 로직**: 어떤 컬럼에서 어떤 데이터를 가져오는지
- ✅ **시트명 생성 규칙**: baseName 생성 방식과 uniqueName 처리
- ✅ **이미지 삽입 로직**: 기존 이미지 처리 방식
- ✅ **서명 워크플로우**: doGet 파라미터와 역할별 처리 (팀장 → 검토자 → 대표)
- ✅ **IMPORTRANGE 수식**: 기존 셀 참조와 수식 구조
- ✅ **다중 승인자 체인**: 각 승인 단계별 다음 보드로 전송하는 로직
- ✅ **역할별 컬럼 매핑**: CFG.COL.CEO, CFG.COL.REVIEWER, CFG.COL.PRESIDENT 등

#### **2. 추가만 하고 변경하지 않을 것들**
- ✅ **PDF 생성 기능**: 기존 로직에 추가만, 변경 금지
- ✅ **팀장 보드 O열 데이터**: PDF 파일 ID 저장 추가만
- ✅ **휴지통 이동 로직**: 새로운 기능 추가만

#### **3. 수정 원칙**
```
❌ 절대 하지 말 것: 기존 함수 로직 변경
✅ 해야 할 것: 새로운 PDF 기능 추가
❌ 절대 하지 말 것: 기존 데이터 흐름 변경
✅ 해야 할 것: O열에 PDF ID 추가 저장
```

#### **4. 🚨 PDF 설정 크리티컬 주의사항**

> ⚠️ **절대 금지**: PDF 생성 시 기존 파일의 사이즈/포맷 설정을 다른 파일 설정으로 변경 금지

**✅ 올바른 방법:**
- **PDF 생성 시기만 변경**: 언제 PDF를 생성할지만 수정
- **기존 PDF 설정 유지**: pdfUrl 파라미터는 각 파일의 기존 설정 그대로 사용

**❌ 절대 하지 말 것:**
```javascript
// 정상 파일에서 가져온 PDF 설정을 다른 파일에 적용 금지
const pdfUrl = `${baseUrl}/export?format=pdf&gid=${gid}&r1=0&r2=15&c1=0&c2=9`; // ❌ 금지
```

**✅ 해야 할 것:**
```javascript
// 각 파일의 기존 PDF 설정 유지
const pdfUrl =
  baseUrl +
  '/export?format=pdf' +
  '&gid=' + gid +
  '&size=A4' + // 각 파일의 기존 설정 그대로 유지
  '&portrait=true' +
  // ... 기존 설정들 그대로 복사
```

**검증 방법:**
1. 수정 전 기존 `exportPdfAndNotify` 함수의 pdfUrl 설정 확인
2. 새로 추가하는 `createPdfFromSheet` 함수에 동일한 설정 적용
3. `&r1=`, `&r2=`, `&c1=`, `&c2=` 등 출력 영역 제한 설정 주의

### **일반 주의사항**

1. **정상 파일(`0덮] 1동 제품검수일지`)은 절대 수정하지 않기**
2. **PDF 폴더 ID와 시트 구조가 파일마다 다를 수 있으므로 각 파일의 CFG 설정 확인 필요**
3. **createPdfFromSheet 함수의 PDF URL 파라미터는 각 파일의 시트 구조에 맞게 조정 필요**
4. **기존 테스트 함수들(`testOnFormSubmit`, `testExportPdf40` 등)은 그대로 유지**